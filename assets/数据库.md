# 数据库

长sql语句 和 多次sql查询结果进行整合，哪种效果比较好
网上答案及个人理解
1：一个一个查出来整合会效率更高
2：分次查询，有利于数据库自动使用到索引，会提高查询效率（极大减少查询时间）
3：一般单表查询，对于业务系统和 orm 框架来说，很多是有缓存的，其实查的是缓存，效率更高，而多表联合查询，一般会禁用这个级别的缓存（利用缓存，减少查询时间）
4：联合查询的sql语句，大多数在查询语法过程中，总数据处理量会变成多表的乘积。总处理数据量是 nm...，那么根本就快不起来。而单表查几条，参与运算的数据量就是主数据加几条关联数据。（多表查询复杂度指数型增长）
大sql其实比小sql实现起来要麻烦得多，中间夹了太多业务，不仅麻烦也易出错，维护的人也不方便（本人在写这个复杂sql的时候经常想半天，更何况别人要看这个sql的人，应该更是一脸懵逼吧）。相对来说小sql，用自己熟悉的语言如java去实现业务逻辑，比较清晰明了。而且使用小sql查询，也许在缓存中就有都不用去查询数据库。
我本来想的是分成多个sql查询，后来想多次查询数据库会降低效率，所以选择了较长的sql实现功能，后来网友告诉我：
1.有连接池复用，不会有太多明显的多次连接开销；
2.背慢锅的一般都是JOIN；
3.其实在ORM框架来看，JOIN产生了中间结果，不是A也不是B而是AB混合体，因此缓存怎么搞（不用缓存了）所以问题3还是各查个的吧然后在应用里面进行数据处理。

一次查询：缺点是如果两个表数据多，则中间结果集太大，需要较多的内存资源，以时间换空间。
多次查询的优缺点和一次查询正好反过来。
多次查询也可以在程序中对每一次查询的中间结果做处理，这是一个灵活性。
一次查询如果数据量大的话，多次查询要快一些，相当于是用空间换时间。
总结：
分开写多次拼装较好，sql写的太长的话，后期如果需要维护或者业务有新的需求会比较麻烦（长远思考：方便维护，和添加新的功能），建议是单一化，便于维护，便于以后别人理解业务（容易阅读）。业务实现最好是简单明了化，这样出错的几率小（正确率提高）。

## 分解查询 & Join 查询

很多高性能的应用都会对关联查询进行分解，用分解关联查询的方式重构查询有如下的优势：

- 让缓存效率更高；
- 将查询分结构后，执行单个查询可以减少锁的竞争；
- 可以减少冗余记录的查询；
- ....

Join 弊端

- 不利于写操作。执行读操作时，会锁住被读的数据，阻塞其他业务对该部分数据的更新操作(U or D)。如果涉及多个聚合函数（缓存中没有max or min时），相当于同时锁住多张表，不能进行读写，直接影响其他业务，这影响了系统的整体性能；
- 不利于维护。业务发生变动时，比如 join 中一张表改了，可能导致系统中原有的 sql 不可用，最终导致基于该 SQL 执行结果的上层显示失败（也意味着以往的开发工作已无效）;

> 如果使用步骤一和步骤二的方式，只需要修改其中一个步骤就行。实际工作中，也就是只需要修改其中的一个service（对应一张表）即可。既影响性能，又不利于维护，所以我们尽量不要用 join。另外，阿里集团不让用三张表，是在OLTP场景中，不要一叶障目哦，如果是在复杂分析型OLAP的应用场景中，使用 join 还是非常合适的。
> OLTP 比较忌讳多个大表连表查询，尤其是在未经特别优化的情况下，适当反范式设计可以减少连接查询提高性能
> OLAP 中大表多表连接查询是不可避免的，除了优化索引，最佳实践就是化整为零，分布计算，一次2-3张表查询结果放入临时表
